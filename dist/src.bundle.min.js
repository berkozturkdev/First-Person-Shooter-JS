class Map{constructor(){this.map_size=0,this.map=[];var e=new THREE.TextureLoader,t=e.load("../assets/img/metal.jpg"),i=e.load("../assets/img/piedras.jpg"),s=Physijs.createMaterial(new THREE.MeshPhongMaterial({map:t}),0,0),a=Physijs.createMaterial(new THREE.MeshPhongMaterial({map:i}),0,0),n=new Physijs.BoxMesh(new THREE.BoxGeometry(200,0,200,1,1,1),s,0);n.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,0)),n.receiveShadow=!0,n.autoUpdateMatrix=!1,this.map.push(n),++this.map_size;var o=new Physijs.BoxMesh(new THREE.BoxGeometry(210,4,400,1,1,1),s,0);o.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,-300)),o.receiveShadow=!0,o.autoUpdateMatrix=!1,this.map.push(o),++this.map_size;var r=new Physijs.BoxMesh(new THREE.BoxGeometry(50,0,50,1,1,1),s,0);r.applyMatrix((new THREE.Matrix4).makeTranslation(0,-10,0)),r.receiveShadow=!1,r.autoUpdateMatrix=!1,this.map.push(r),++this.map_size;var h=new Physijs.BoxMesh(new THREE.BoxGeometry(220,8,20,1,1,1),s,0);h.applyMatrix((new THREE.Matrix4).makeTranslation(0,2.5,100)),h.receiveShadow=!0,h.autoUpdateMatrix=!1,this.map.push(h),++this.map_size;var l=new Physijs.BoxMesh(new THREE.BoxGeometry(20,8,200,1,1,1),s,0);l.applyMatrix((new THREE.Matrix4).makeTranslation(100,2.5,0)),l.receiveShadow=!0,l.autoUpdateMatrix=!1,this.map.push(l),++this.map_size;var c=new Physijs.BoxMesh(new THREE.BoxGeometry(20,8,200,1,1,1),s,0);c.applyMatrix((new THREE.Matrix4).makeTranslation(-100,2.5,0)),c.receiveShadow=!0,c.autoUpdateMatrix=!1,this.map.push(c),++this.map_size;var d=new Physijs.BoxMesh(new THREE.BoxGeometry(220,4,8,1,1,1),s,0);d.applyMatrix((new THREE.Matrix4).makeTranslation(0,2.5,-96)),d.receiveShadow=!0,d.autoUpdateMatrix=!1,this.map.push(d),++this.map_size;var m=new Physijs.CylinderMesh(new THREE.CylinderGeometry(50,500,50,10,10),a,0);return m.applyMatrix((new THREE.Matrix4).makeTranslation(0,-40,-50)),m.receiveShadow=!0,m.autoUpdateMatrix=!1,this.map.push(m),++this.map_size,this}getMap(e){return this.map[e]}getMapSize(){return this.map_size}}class Enemies{constructor(e,t){this.enemies=[],this.countCollitions=[],this.direction=[],this.force=0,this.init=!0,this.countDead=0,this.scene=e,this.force=1==t?5:2==t?10:3==t?20:4==t?30:5==t?50:6==t?70:7==t?90:8==t?100:9==t?120:150;var i=(new THREE.TextureLoader).load("../assets/img/diana.png");this.mat1=Physijs.createMaterial(new THREE.MeshPhongMaterial({map:i}),0,0),this.mat2=Physijs.createMaterial(new THREE.MeshPhongMaterial({map:i}),0,0),this.mat3=Physijs.createMaterial(new THREE.MeshPhongMaterial({map:i}),0,0),this.mat4=Physijs.createMaterial(new THREE.MeshPhongMaterial({map:i}),0,0);var s=new Physijs.BoxMesh(new THREE.BoxGeometry(7.5,10,2.5,1,1,1),this.mat1,1);s.applyMatrix((new THREE.Matrix4).makeTranslation(100,7,-150)),s.receiveShadow=!0,s.autoUpdateMatrix=!1,this.countCollitions.push(0),this.direction.push("left"),this.enemies.push(s),this.scene.add(s),this.addBulletListener(this.enemies.length-1);var a=new Physijs.BoxMesh(new THREE.BoxGeometry(7.5,10,2.5,1,1,1),this.mat2,1);a.applyMatrix((new THREE.Matrix4).makeTranslation(-100,7,-250)),a.receiveShadow=!0,a.autoUpdateMatrix=!1,this.countCollitions.push(0),this.direction.push("right"),this.enemies.push(a),this.scene.add(a),this.addBulletListener(this.enemies.length-1);var n=new Physijs.BoxMesh(new THREE.BoxGeometry(7.5,10,2.5,1,1,1),this.mat3,1);n.applyMatrix((new THREE.Matrix4).makeTranslation(100,7,-350)),n.receiveShadow=!0,n.autoUpdateMatrix=!1,this.countCollitions.push(0),this.direction.push("left"),this.enemies.push(n),this.scene.add(n),this.addBulletListener(this.enemies.length-1);var o=new Physijs.BoxMesh(new THREE.BoxGeometry(7.5,10,2.5,1,1,1),this.mat4,1);return o.applyMatrix((new THREE.Matrix4).makeTranslation(-100,7,-450)),o.receiveShadow=!0,o.autoUpdateMatrix=!1,this.countCollitions.push(0),this.direction.push("right"),this.enemies.push(o),this.scene.add(o),this.addBulletListener(this.enemies.length-1),this}addBulletListener(e){var t=this;this.enemies[e].addEventListener("collision",function(i,s,a,n){1==t.countCollitions[e]&&(new Howl({src:["../assets/sounds/death.mp3"],volume:.3}).play(),scene.updateScore(10),t.countDead++,4==t.countDead&&(scene.level++,scene.newLevel()));t.countCollitions[e]++})}getEnemies(e){return this.enemies[e]}getEnemiesSize(){return this.enemies.length}animate(){for(var e=0;e<this.enemies.length;++e)this.enemies[e].position.x>=100&&"left"==this.direction[e]?(this.enemies[e].applyCentralImpulse(new THREE.Vector3(-this.force,0,0)),this.direction[e]="right"):this.enemies[e].position.x<=-100&&"right"==this.direction[e]&&(this.enemies[e].applyCentralImpulse(new THREE.Vector3(this.force,0,0)),this.direction[e]="left");this.init&&(this.force*=2,this.init=!1),-150!=this.enemies[0].position.z&&-250!=this.enemies[1].position.z&&-350!=this.enemies[2].position.z&&-450!=this.enemies[3].position.z&&(scene.level++,scene.newLevel())}}class Skybox extends THREE.Object3D{constructor(){super(),this.lenghtxz=1e3,this.heighty=1e3,this.skybox=null;var e=new THREE.BoxGeometry(this.lenghtxz,this.heighty,this.lenghtxz);const t=this._getMaterial("../assets/img/skybox/yokohoma/");this.skybox=new THREE.Mesh(e,t),this.skybox.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,0)),this.add(this.skybox)}_getMaterial(e){const t=new THREE.TextureLoader,i=i=>new THREE.MeshBasicMaterial({map:t.load(e+i+".jpg"),side:THREE.BackSide});return[i("front"),i("back"),i("top"),i("down"),i("right"),i("left")]}}class Crosshair extends THREE.Object3D{constructor(){super(),this.material=new THREE.LineBasicMaterial({color:2359042}),this.xLenght=7e-4,this.yLenght=.005,this.zLenght=0,this.crosshairPos=.0075,this.crosshair=null,this.crosshair=this.createRoot(),this.add(this.crosshair)}createRoot(){var e=new THREE.Object3D;return e.castShadow=!1,e.autoUpdateMatrix=!1,e.updateMatrix(),e.add(this.createCrosshair("U")),e.add(this.createCrosshair("D")),e.add(this.createCrosshair("L")),e.add(this.createCrosshair("R")),e}createCrosshair(e){var t=new THREE.Mesh(new THREE.BoxGeometry(this.xLenght,this.yLenght,this.zLenght),this.material);switch(t.castShadow=!1,t.autoUpdateMatrix=!1,e){case"U":t.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(0,this.crosshairPos,0));break;case"D":(t=new THREE.Mesh(new THREE.BoxGeometry(this.xLenght,this.yLenght,this.zLenght),this.material)).geometry.applyMatrix((new THREE.Matrix4).makeTranslation(0,-this.crosshairPos,0));break;case"L":(t=new THREE.Mesh(new THREE.BoxGeometry(this.yLenght,this.xLenght,this.zLenght),this.material)).geometry.applyMatrix((new THREE.Matrix4).makeTranslation(-this.crosshairPos,0,0));break;case"R":(t=new THREE.Mesh(new THREE.BoxGeometry(this.yLenght,this.xLenght,this.zLenght),this.material)).geometry.applyMatrix((new THREE.Matrix4).makeTranslation(this.crosshairPos,0,0))}return t.updateMatrix(),t}}class Avatar{constructor(e,t){var i=Physijs.createMaterial(new THREE.MeshPhongMaterial({color:0}),1,0);this.avatar=new THREE.Mesh(new THREE.BoxGeometry(5,5,5),i),this.avatar.material.transparent=!0,this.avatar.material.opacity=0,this.avatar.position.y=2.5,this.avatar.__dirtyPosition=!0,t.add(this.avatar),this.camera=e,this.controls=controls,this.activeWeapon=null,this.goingUp=!0,this.recoil=!0,this.posLimite=82,this.shotgun=null,this.rifle=null,this.avatar.add(this.camera)}getPosition(){var e=new THREE.Vector3;return e.x=this.avatar.position.x,e.y=this.avatar.position.y,e.z=this.avatar.position.z,e}setInitialPosition(){this.avatar.position.set(0,2.5,0)}getActiveWeapon(){return this.activeWeapon}jump(){this.goingUp?this.avatar.position.y>15?this.goingUp=!1:this.avatar.position.y+=.5:this.avatar.position.y>=2&&this.avatar.position.y<=2.5?(jumping=!1,this.goingUp=!0):this.avatar.position.y-=.5}updateControls(){controls.getObject().position.set(this.avatar.position.x,this.avatar.position.y+5,this.avatar.position.z)}moveForward(){var e=this.camera.getWorldDirection(),t=e.x+this.avatar.position.x;t<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateX(e.x),(t=e.z+this.avatar.position.z)<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateZ(e.z)}moveBackward(){var e=this.camera.getWorldDirection(),t=-e.x+this.avatar.position.x;t<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateX(-e.x),(t=-e.z+this.avatar.position.z)<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateZ(-e.z)}moveLeft(){var e=this.camera.getWorldDirection(),t=e.z+this.avatar.position.x;t<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateX(e.z),(t=-e.x+this.avatar.position.z)<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateZ(-e.x)}moveRight(){var e=this.camera.getWorldDirection(),t=-e.z+this.avatar.position.x;t<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateX(-e.z),(t=e.x+this.avatar.position.z)<=this.posLimite&&t>=-this.posLimite&&this.avatar.translateZ(e.x)}changeWeapon(){0==this.activeWeapon?(this.rifle.material.transparent=!0,this.rifle.material.opacity=0,this.shotgun.material.transparent=!1,this.shotgun.material.opacity=1,this.activeWeapon=1):1==this.activeWeapon&&(this.shotgun.material.transparent=!0,this.shotgun.material.opacity=0,this.rifle.material.transparent=!1,this.rifle.material.opacity=1,this.activeWeapon=0)}animateWeapon(){0==this.activeWeapon?this.recoil?this.rifle.rotation.x>=.2?this.recoil=!1:this.rifle.rotation.x+=.1:this.rifle.rotation.x>=0&&this.rifle.rotation.x<=.1?(disparando=!1,this.recoil=!0):this.rifle.rotation.x-=.1:1==this.activeWeapon&&(this.recoil?this.shotgun.rotation.x>=1.8?this.recoil=!1:this.shotgun.rotation.x+=.1:this.shotgun.rotation.x>=0&&this.shotgun.rotation.x<=.1?(disparando=!1,this.recoil=!0):this.shotgun.rotation.x-=.1)}loadWeapons(){var e=this.camera,t=this,i=new THREE.MTLLoader,s=new THREE.OBJLoader,a=null;i.setPath("../assets/models/"),i.load("material.mtl",function(i){i.preload(),s.setMaterials(i),s.setPath("../assets/models/"),s.load("m4a1_s.obj",function(i){a=THREE.ImageUtils.loadTexture("../assets/models/m4a1_stext.png"),i.children[1].material=new THREE.MeshLambertMaterial({map:a}),i.children[1].position.set(0,0,0),i.children[1].scale.set(.2,.2,.2),i.children[1].rotation.set(.1,3.4,0),i.children[1].position.set(2,-.8,-2),t.rifle=i.children[1],e.add(t.rifle),t.activeWeapon=0})}),i.setPath("../assets/models/"),i.load("material.mtl",function(i){i.preload(),s.setMaterials(i),s.setPath("../assets/models/"),s.load("escopeta.obj",function(i){a=THREE.ImageUtils.loadTexture("../assets/models/escopetatext.png"),i.children[0].material=new THREE.MeshLambertMaterial({map:a}),i.children[0].position.set(0,0,0),i.children[0].scale.set(.4,.4,.4),i.children[0].rotation.set(.2,-1.2,0),i.children[0].position.set(2,-1.4,-6),i.children[0].material.transparent=!0,i.children[0].material.opacity=0,t.shotgun=i.children[0],e.add(t.shotgun)})})}}class Bullets{constructor(e,t,i){this.material=i,this.objWidth=1,this.maxBullets=e,this.bullets=[],this.launched=[],this.target=[];for(var s=0;s<e;++s)this.launched[s]=!1,this.target[s]=new THREE.Vector3(0,0,0),this.bullets[s]=this.createObject(s),t.add(this.bullets[s])}getLaunched(e){return this.launched[e]}setLaunched(e){this.launched[e]=!1}getParameters(e){return{x:this.bullets[e].position.x,y:this.bullets[e].position.y,z:this.bullets[e].position.z,radio:this.objWidth/2}}reload(){for(var e=0;e<this.maxBullets;++e)this.bullets[e].remove(),this.launched[e]=!1,this.target[e]=new THREE.Vector3(0,0,0),this.bullets[e]=this.createObject(e),scene.add(this.bullets[e])}createObject(e){var t=new Physijs.SphereMesh(new THREE.SphereGeometry(this.objWidth/4,20,20),this.material,50);return t.position.set(e,-9.5,0),t.castShadow=!0,t}setInitPosition(e){this.bullets[e].position.x=e,this.bullets[e].position.y=-9.5,this.bullets[e].position.z=0,this.bullets[e].__dirtyPosition=!0}dispara(e,t,i,s){this.target[e].set(i.x,i.y,i.z),this.bullets[e].position.set(t.x-i.x,t.y+5,t.z-i.z),this.bullets[e].setCcdMotionThreshold(10),this.bullets[e].setCcdSweptSphereRadius(this.objWidth/4),this.bullets[e].__dirtyPosition=!0,this.launched[e]=!0;var a=null,n=null;0==s?(a=35e3,n=new Howl({src:["../assets/sounds/m4a1_s.mp3"],volume:.1})):1==s&&(a=5e4,n=new Howl({src:["../assets/sounds/escopeta.mp3"],volume:.1}));var o=new THREE.Vector3(this.target[e].x*a,this.target[e].y*a,this.target[e].z*a);this.bullets[e].applyCentralImpulse(o),n.play()}}class TheScene extends Physijs.Scene{constructor(e,t){super(),this.setGravity(new THREE.Vector3(0,-50,0)),this.camera=t,this.createCrosshair(e),this.avatar=null,this.map=null,this.enemies=null,this.skybox=null,this.Bullets=null,this.index=0,this.maxBullets=20,this.actualAmmo=40,this.score=0,this.lastScore=0,this.level=1,this.createHUD(),this.createAvatar(),this.avatar.loadWeapons(),this.place=this.createPlace(),this.createBullets(),this.createEnemies(this.level),this.ambientLight=null,this.spotLight=null,this.createLights(),this.add(this.place)}createHUD(){var e=document.createElement("div");e.id="score",e.style.position="absolute",e.style.width=1,e.style.height=1,e.innerHTML="Puntuación: "+this.score,e.style.top="50px",e.style.left="50px",e.style.fontSize="50px",e.style.color="white",document.body.appendChild(e);var t=document.createElement("div");t.id="ammo",t.style.position="absolute",t.style.width=1,t.style.height=1,t.innerHTML="Munición: "+this.actualAmmo,t.style.top="100px",t.style.left="50px",t.style.fontSize="50px",t.style.color="white",document.body.appendChild(t);var i=document.createElement("div");i.id="level",i.style.position="absolute",i.style.width=1,i.style.height=1,i.innerHTML="Nivel: "+this.level,i.style.top="150px",i.style.left="50px",i.style.fontSize="50px",i.style.color="white",document.body.appendChild(i)}updateAmmo(){document.getElementById("ammo").innerHTML="Munición: "+this.actualAmmo}updateScore(e){var t=document.getElementById("score");this.score+=e,t.innerHTML="Puntuacion: "+this.score}updateLevel(){document.getElementById("level").innerHTML="Nivel: "+this.level}createCrosshair(e){var t=new Crosshair;this.camera.add(t);t.position.set(0,0,-.3)}dispara(){this.index>=this.maxBullets&&(this.index=0,this.bullets.reload()),disparando||(this.bullets.dispara(this.index,this.avatar.getPosition(),this.camera.getWorldDirection(),this.avatar.getActiveWeapon()),this.index++,this.actualAmmo--,this.updateAmmo())}createLights(){this.ambientLight=new THREE.AmbientLight(13426158,.35),this.add(this.ambientLight),this.spotLight=new THREE.SpotLight(16777215),this.spotLight.position.set(0,500,1e3),this.spotLight.intensity=1,this.spotLight.castShadow=!0,this.spotLight.shadow.mapSize.width=2048,this.spotLight.shadow.mapSize.height=2048,this.add(this.spotLight)}createPlace(){var e=new THREE.Object3D;this.skybox=new Skybox,e.add(this.skybox),this.map=new Map;for(var t=0;t<this.map.getMapSize();++t)this.add(this.map.getMap(t));return e}createAvatar(){this.avatar=new Avatar(this.camera,this)}createBullets(){var e=(new THREE.TextureLoader).load("../assets/img/bullettext.jpg");this.bullets=new Bullets(this.maxBullets,this,new THREE.MeshPhongMaterial({map:e}))}createEnemies(){this.enemies=new Enemies(this,this.level)}endGame(){enableControls=!1,controls.enabled=!1,moveForward=!1,moveBackward=!1,moveLeft=!1,moveRight=!1,jumping=!1,blocker.style.display="block",instructions.style.display="",instructions.style.fontSize="50px",instructions.innerHTML="Puntuacion total: "+this.score+", pulsa la tecla P para jugar otra partida."}animate(){this.simulate(),moveForward&&this.avatar.moveForward(),moveBackward&&this.avatar.moveBackward(),moveLeft&&this.avatar.moveLeft(),moveRight&&this.avatar.moveRight(),jumping&&this.avatar.jump(),disparando&&this.avatar.animateWeapon(),this.avatar.updateControls(),this.enemies.animate(),0==this.actualAmmo&&this.endGame()}changeWeapon(){this.avatar.changeWeapon()}getCamera(){return this.camera}getCameraControls(){return this.controls}setCameraAspect(e){this.camera.aspect=e,this.camera.updateProjectionMatrix()}newLevel(){this.avatar.setInitialPosition(),this.score-this.lastScore!=40&&(this.score=this.lastScore+40),this.updateLevel();for(var e=0;e<this.enemies.getEnemiesSize();++e)this.remove(this.enemies.getEnemies(e));this.createEnemies(),this.lastScore=this.score}newGame(){blocker.style.display="none",enableControls=!0,controls.enabled=!0,this.avatar.setInitialPosition(),this.actualAmmo=40,this.updateAmmo(),this.score=0,this.updateScore(0),this.level=1,this.updateLevel();for(var e=0;e<this.enemies.getEnemiesSize();++e)this.remove(this.enemies.getEnemies(e));this.createEnemies()}}function createGUI(e){new dat.GUI;e&&(stats=initStats())}function initStats(){var e=new Stats;return e.setMode(0),e.domElement.style.position="absolute",e.domElement.style.left="0px",e.domElement.style.top="0px",$("#Stats-output").append(e.domElement),e}function setMessage(e){document.getElementById("Messages").innerHTML="<h2>"+e+"</h2>"}function onMouseDown(e){enableControls&&1==e.buttons&&"none"==blocker.style.display&&(scene.dispara(),disparando=!0)}function onKeyDown(e){if(enableControls)switch(e.keyCode){case 38:case 87:moveForward=!0;break;case 37:case 65:moveLeft=!0;break;case 40:case 83:moveBackward=!0;break;case 39:case 68:moveRight=!0;break;case 32:jumping=!0;break;case 81:disparando||scene.changeWeapon()}80==e.keyCode&&0==enableControls&&scene.newGame()}function onKeyUp(e){if(enableControls)switch(e.keyCode){case 38:case 87:moveForward=!1;break;case 37:case 65:moveLeft=!1;break;case 40:case 83:moveBackward=!1;break;case 39:case 68:moveRight=!1}}function onMouseWheel(e){enableControls&&(disparando||scene.changeWeapon())}function onWindowResize(){scene.setCameraAspect(window.innerWidth/window.innerHeight),renderer.setSize(window.innerWidth,window.innerHeight)}function createRenderer(){var e=new THREE.WebGLRenderer;return e.setClearColor(new THREE.Color(15658734),1),e.setPixelRatio(window.devicePixelRatio),e.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(e.domElement),e.shadowMap.enabled=!0,e}function render(){requestAnimationFrame(render),stats.update(),scene.animate(),renderer.render(scene,scene.getCamera()),scene.simulate()}scene=null,stats=null,mouseDown=!1,renderer=null,camera=null,controls=null,moveForward=!1,moveBackward=!1,moveLeft=!1,moveRight=!1,jumping=!1,disparando=!1,enableControls=!0,$(function(){"use strict";Physijs.scripts.worker="../libs/physijs_worker.js",Physijs.scripts.ammo="../libs/ammo.js";var e=document.getElementById("instructions");document.getElementById("title");if("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document){var t=document.body,i=function(i){document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t?(!0,controls.enabled=!0,enableControls=!0,blocker.style.display="none"):(blocker.style.display="block",e.style.display="",e.style.fontSize="50px",e.innerHTML="PAUSA",enableControls=!1,controls.enabled=!1)},s=function(t){e.style.display=""};document.addEventListener("pointerlockchange",i,!1),document.addEventListener("mozpointerlockchange",i,!1),document.addEventListener("webkitpointerlockchange",i,!1),document.addEventListener("pointerlockerror",s,!1),document.addEventListener("mozpointerlockerror",s,!1),document.addEventListener("webkitpointerlockerror",s,!1),e.addEventListener("click",function(i){e.style.display="none",t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.requestPointerLock()},!1)}else e.innerHTML="Your browser doesn't seem to support Pointer Lock API";camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),renderer=createRenderer(),$("#WebGL-output").append(renderer.domElement),window.addEventListener("resize",onWindowResize),window.addEventListener("mousedown",onMouseDown,!0),window.addEventListener("keydown",onKeyDown,!0),window.addEventListener("keyup",onKeyUp,!0),window.addEventListener("mousewheel",onMouseWheel,!0),window.addEventListener("DOMMouseScroll",onMouseWheel,!0),scene=new TheScene(renderer.domElement,camera),controls=new THREE.PointerLockControls(camera),scene.add(controls.getObject()),createGUI(!0),render()});